<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>实名认证</title>
    <link rel="stylesheet" href="/css/weui.min.css">
    <link rel="stylesheet" href="/css/lib/common.css">
    <script src="/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/js/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
    <script type="text/javascript" src="/js/weui.min.js"></script>
    <style>
        .weui-cells {
            margin-top: 0;
        }
        
        a img {
            max-width: 100%;
            border: 0;
        }
        
        .weui-grid:before {
            border-right: none;
        }
        
        .weui-grid:after {
            border-bottom: none;
        }
        
        .weui-grids:before {
            border-top: none;
        }
        
        .weui-grids:after {
            border-left: none;
        }
        .weui-grid img{
            height:5.7rem;
        }
        .footer{
            z-index: 10;
        }
    </style>
</head>

<body>
    <form id="form">
    <div class="container">
        <div class="weui-cells" style="border-bottom:0.8rem solid #f5f5f5;border-top:0.8rem solid #f5f5f5;">
        <div class="weui-cells">
                <a class="weui-cell weui-cell_access type" href="javascript:;">
                    <div class="weui-cell__bd">
                     {if condition="$info['credtype']==1"}
                      <p id="types">证件类型：普通证件</p>
                     {else /}
                      <p id="types">证件类型：多证合一</p>
                     {/if}
                        
                        <input type="hidden" name="credtype" id="credtype" value="{$info['credtype']}">
                    </div>
                    <div class="weui-cell__ft">
                    </div>
                </a>
            </div>
        </div>
        <div class="content " style="border-bottom:0.8rem solid #F5F5F5; ">
            <div class="weui-cells weui-cells_form ">
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">公司名称</label></div>
                    <div class="weui-cell__bd ">
                        <input class="weui-input " style="text-align: -webkit-right; " name="bizname" type="text " value="{$info['bizname']}" placeholder="请输入公司名称" />
                    </div>
                </div>
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">企业注册号</label></div>
                    <div class="weui-cell__bd ">
                        <input class="weui-input " style="text-align: -webkit-right; " name="compno" type="text " value="{$info['compno']|default=''}" placeholder="请输入企业注册号 " />
                    </div>
                </div>
            </div>
        </div>
        <div class="content " style="border-bottom:0.8rem solid #F5F5F5;">
            <div class="weui-cells weui-cells_form ">
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">艺名</label></div>
                    <div class="weui-cell__bd ">
                        <input class="weui-input " style="text-align: -webkit-right; " name="names" value="{$info['names']|default=''}" type="text " placeholder="请输入艺名 " />
                    </div>
                </div>
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">姓名</label></div>
                    <div class="weui-cell__bd ">
                        <input class="weui-input " style="text-align: -webkit-right; " name="oldname" type="text " value="{$info['oldname']|default=''}" placeholder="请输入姓名 " />
                    </div>
                </div>
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">身份证号码</label></div>
                    <div class="weui-cell__bd ">
                        <input class="weui-input " style="text-align: -webkit-right; " value="{$info['idno']|default=''}" name="idno" type="number " pattern="[0-9]* " placeholder="请输入身份证号码 " />
                    </div>
                </div>
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">邮箱</label></div>
                    <div class="weui-cell__bd ">
                        <input class="weui-input " style="text-align: -webkit-right; " name="email" value="{$info['email']|default=''}" type="text " pattern="[0-9]* " placeholder="请输入邮箱 " />
                    </div>
                </div>
            </div>
        </div>
        <div class="content ">
            <div class="weui-cells weui-cells_form " style="margin-top:0; ">
                <div class="weui-cell ">
                    <div class="weui-cell__hd "><label class="weui-label ">上传证件</label></div>

                </div>
            </div>
        </div>
        <div class="weui-grids" style="margin-bottom:1.5rem;">
            <a href="javascript:;" class="weui-grid" style="width:50%;height:180px" onclick="setvar(1)" id="selectfiles1">
                <div class="">
                    <img src="{$info['tradcert']|default='/imgs/add_icon.png'}" id="img1" style="width:100%">
                    <input type="hidden" name="tradcert" value="{$info['tradcert']|default=''}" id="imgurl1">
                </div>
                <p class="weui-grid__label">营业执照</p>
            </a>
            <a href="javascript:;" class="weui-grid" style="width:50%;" onclick="setvar(2)" id="selectfiles2">
                <div class="">
                    <img src="{$info['entrus']|default='/imgs/add_icon.png'}" style="width:100%" id="img2">
                    <input type="hidden" name="entrus" value="{$info['entrus']|default=''}" id="imgurl2">
                </div>
                <p class="weui-grid__label">企业委托书</p>
            </a>
            <a href="javascript:;" class="weui-grid" style="width:50%;" onclick="setvar(3)" id="selectfiles3">
                <div class="">
                    <img src="{$info['admcard']|default='/imgs/add_icon.png'}" style="width:100%" id="img3">
                    <input type="hidden" name="admcard" value="{$info['admcard']|default=''}" id="imgurl3">
                </div>
                <p class="weui-grid__label">身份证正面</p>
            </a>
            <a href="javascript:;" class="weui-grid" style="width:50%;" onclick="setvar(4)" id="selectfiles4">
                <div class="">
                    <img src="{$info['reveside']|default='/imgs/add_icon.png'}" style="width:100%" id="img4">
                    <input type="hidden" name="reveside" value="{$info['reveside']|default=''}" id="imgurl4">
                </div>
                <p class="weui-grid__label">身份证反面</p>
            </a>
            <a href="javascript:;" class="weui-grid" style="width:50%;" onclick="setvar(5)" id="selectfiles5">
                <div class="">
                    <img src="{$info['handid']|default='/imgs/add_icon.png'}" style="width:100%" id="img5">
                    <input type="hidden" name="handid" value="{$info['handid']|default=''}" id="imgurl5">
                </div>
                <p class="weui-grid__label">手持身份证正面照</p>
            </a>
            {if condition="$info['credtype']==1"}
            <a href="javascript:;" class="weui-grid show" style="width:50%;">
                <div class="" onclick="setvar(6)" id="selectfiles6">
                    <img src="{$info['groupcode']|default='/imgs/add_icon.png'}" style="width:100%" id="img6">
                    <input type="hidden" name="groupcode" value="{$info['groupcode']|default=''}" id="imgurl6">
                </div>
                <p class="weui-grid__label">组织机构代码证</p>
            </a>
            {/if}
        </div>
    </div>
    <input type="hidden" name="id" value="{$info['id']|default=''}">
    </form>
    <footer class="footer " id="up">保存并上传</footer>
    </div>
</body>
<script>
      $(".type").click(function(){
      weui.picker([
          {
              label: '多证合一',
              value: 2
          },
          {
              label: '普通证件',
              value: 1
          }
      ], {
          className: 'custom-classname',
          defaultValue: [1],
          onConfirm: function (result) {
              $("#types").text('证件类型：'+result[0]['label']);
              var types = result[0]['value'];
              $("#credtype").val(types);
              console.log(types);
              if(types==1){
                  $('.show').css('display','block');
              }else if(types==2){
                $('.show').css('display','none');
                $("#imgurl6").val('');
                $("#img6").attr('src','/imgs/add_icon.png');
              }
          },
          id: 'singleLinePicker'
      });
  })
</script>
<script>
        //上传
      function setvar(valnum) {
          whichf = valnum;
      }
    
      accessid = '';
      accesskey = '';
      host = '';
      policyBase64 = '';
      signature = '';
      callbackbody = '';
      filename = '';
      key = '';
      expire = 0;
      g_object_name = '';
      g_object_name_type = '';
      now = timestamp = Date.parse(new Date()) / 1000;
      fname = '';
      whichf = 1;
    
      //实例化一个plupload上传对象
      var uploader = new plupload.Uploader({
          browse_button: ['selectfiles1', 'selectfiles2', 'selectfiles3','selectfiles4','selectfiles5','selectfiles6',], //触发文件选择对话框的按钮，为那个元素id
          url: 'upload.php', //服务器端的上传页面地址
          flash_swf_url: 'js/Moxie.swf', //swf文件，当需要使用swf方式进行上传时需要配置该参数
          silverlight_xap_url: 'js/Moxie.xap' //silverlight文件，当需要使用silverlight方式进行上传时需要配置该参数
    
      });
    
      uploader.init();
      uploader.bind('FilesAdded', function (uploader, files) {
          uploader.start();
          loading = weui.loading('请稍后', {
              className: 'custom-classname'
            });
      });
    
      uploader.bind('FileUploaded', function (uploader, file, info) {
          if (info.status == 200)
          {
            loading.hide(function() {
            });
              $("#img" + whichf).attr('src', host + "/" + g_object_name);
              $("#imgurl" + whichf).val( host + "/" + g_object_name);
             
          }
      });
      uploader.bind('BeforeUpload', function (uploader, file) {
          ret = get_signature();
          g_object_name = key;
          filetmp = file.name;
          if (filetmp != '') {
              suffix = get_suffix(filetmp)
              calculate_object_name(filetmp)
          }
          new_multipart_params = {
              'key': g_object_name,
              'policy': policyBase64,
              'OSSAccessKeyId': accessid,
              'success_action_status': '200', //让服务端返回200,不然，默认会返回204
              'callback': callbackbody,
              'signature': signature,
          };
    
          uploader.setOption({
              'url': host,
              'multipart_params': new_multipart_params
          });
    
      });
      function get_signature()
      {
    //可以判断当前expire是否超过了当前时间,如果超过了当前时间,就重新取一下.3s 做为缓冲
          now = timestamp = Date.parse(new Date()) / 1000;
    //if (expire < now + 3)
    //{
          body = send_request();
          var obj = eval("(" + body + ")");
          host = obj['data']['domain']
          policyBase64 = obj['data']['policy']
          accessid = obj['data']['accessid']
          signature = obj['data']['signature']
          expire = parseInt(obj['data']['expire'])
          callbackbody = obj['data']['callback']
          key = obj['data']['dir']
          fname = obj['data']['fname']
          return true;
    //}
    //return false;
      }
      function calculate_object_name(filename)
      {
          suffix = get_suffix(filename);
          g_object_name = g_object_name + "/" + fname + suffix;
          return '';
      }
      function send_request()
      {
          var xmlhttp = null;
          if (window.XMLHttpRequest)
          {
              xmlhttp = new XMLHttpRequest();
          } else if (window.ActiveXObject)
          {
              xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
          }
    
          if (xmlhttp != null)
          {
              serverUrl = 'https://api.youxingku.cn/aliyun/upload/php/get.php';
              xmlhttp.open("POST", serverUrl, false);
              xmlhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              xmlhttp.send("types=1&uid=777");
              return xmlhttp.responseText;
          } else
          {
              alert("Your browser does not support XMLHTTP.");
          }
      }
      function get_suffix(filename) {
          pos = filename.lastIndexOf('.')
          suffix = ''
          if (pos != -1) {
              suffix = filename.substring(pos)
          }
          return suffix;
      }
      //提交表单
      $("#up").click(function(){
        var info = $("#form").serialize()
        info = decodeURIComponent(info,true);
        var v = via(info);
        if(v==11){
            weui.alert('请完善信息！');
            return;
        }else if(v==2){
            weui.alert('请输入正确的身份证号码！');
            return;
        }else if(v==3){
            weui.alert('请输入正确的邮箱！');
            return;
        }else if(v==4){
            weui.alert('请输入公司名称！');
            return;
        }else if(v==5){
            weui.alert('请输入企业注册号！');
            return;
        }else if(v==6 || v==7){
            weui.alert('请输入名字！');
            return;
        }else if(v==8){
            weui.alert('请上传营业执照！');
            return;
        }else if(v==9){
            weui.alert('请上传企业委托书！');
            return;
        }else if(v==10){
            weui.alert('请上传身份证！');
            return;
        }else if(v==12){
            weui.alert('请上传组织结构代码证！');
            return;
        }

        var loading = weui.loading('请稍后', {
          className: 'custom-classname'
        });
       $.ajax({
           url:"/index/userinfo/doeditauth",
           type:"POST",
           data:info,
           dataType:'JSON',
           success:function (data) {
            //console.log(data);return;
            if(data==1){
               loading.hide(function() {
               });
                weui.toast('操作成功', {
                  duration: 1500,
                  className: 'custom-classname',
                  callback: function(){
                     window.location.href = '/index/sign/myinfo';
                 }
            });
            }else if(data==2){
                loading.hide(function() {
               });
                weui.alert('您已提交过信息！');
            }
           }
       });
    })

    function via(info){
        var card = $("input[name='idno']").val(); 
        var email = $("input[name='email']").val(); 
        var bizname = $("input[name='bizname']").val(); 
        var compno = $("input[name='compno']").val(); 
        var names = $("input[name='names']").val(); 
        var names = $("input[name='oldname']").val(); 
        var tradcert = $("input[name='tradcert']").val(); 
        var entrus = $("input[name='entrus']").val(); 
        var admcard = $("input[name='admcard']").val(); 
        var reveside = $("input[name='reveside']").val(); 
        var handid = $("input[name='handid']").val(); 
        var credtype = $("input[name='credtype']").val(); 
        var groupcode = $("input[name='groupcode']").val(); 
        var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
        var em = /^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;
        if(bizname==''){
            return 4;
        }
        if(compno==''){
            return 5;
        }
        if(names==''){
            return 6;
        }
        if(names==''){
            return 7;
        }
        if(!reg.test(card)){
            return 2;
        }
        if(tradcert==''){
            return 8;
        }
        if(entrus==''){
            return 9;
        }
        if(reveside==''||admcard==''||handid==''){
            return 10;
        }
      
        if(!em.test(email)){
            return 3;
        }
        if(credtype==1){
            if(groupcode==''){
                return 12;
            }
        }
        return true;
    }
    </script>
</html>